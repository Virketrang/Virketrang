name: Webshop Server Deployment

on:
    push:
        branches: [master]

jobs:
    build-and-deploy:
        name: Setup, Build and Deploy Webshop Server

        runs-on: ubuntu-latest
        env:
            PROJECT_ID: ${{ secrets.WEBSHOP_SERVER_CLOUD_RUN_PROJECT_ID }}
            REGION: europe-north1
            IMAGE_NAME: webshop-server

        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - id: "auth"
              uses: "google-github-actions/auth@v0"
              with:
                  service_account_key: ${{ secrets.WEBSHOP_SERVER_GOOGLE_CLOUD_SERVICE_ACCOUNT_KEY }}
                  project_id: ${{ env.GOOGLE_CLOUD_PROJECT_ID }}
                  export_default_credentials: true

            - name: Setup Cloud SDK
              uses: google-github-actions/setup-gcloud@master

            - name: Authorize Docker push
              run: gcloud auth configure-docker --quiet

            - name: Build and tag the docker image
              run: docker-compose build webshop-server --tag $IMAGE_NAME:latest

            - name: Push the image to the Google Artifact Registry
              env:
                  GIT_TAG: v0.0.1
              run: |-
                  docker tag $IMAGE_NAME:latest eu.gcr.io/$PROJECT_ID/$IMAGE_NAME:latest
                  docker tag $IMAGE_NAME:latest eu.gcr.io/$PROJECT_ID/$IMAGE_NAME:$GIT_TAG
                  docker push eu.gcr.io/$PROJECT_ID/$IMAGE_NAME:latest
                  docker push eu.gcr.io/$PROJECT_ID/$IMAGE_NAME:$GIT_TAG
